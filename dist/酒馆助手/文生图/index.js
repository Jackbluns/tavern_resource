const e="image_tag",t=new RegExp(`<${e}>(.+?)</${e}>`,"gs");async function n(n){const a=[...getChatMessages(n)[0].message.matchAll(t)].map((e=>function(e){const t=$(`<div class="text_to_image_container" id="text_to_image-${Math.random().toString(36).slice(2,9)}">`);return t.append("<style>.text_to_image_button{align-items:center;background:linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);border-radius:2px;border:none;box-shadow:0 4px 6px rgba(99,102,241,.2);color:#fff;cursor:pointer;display:inline-flex;font-size:13px;font-weight:600;gap:8px;outline:none;padding:3px 4px;transition:all .3s ease;white-space:nowrap}</style>"),t.append($(`<button class="text_to_image_button" data="${_.escape(e.trim())}"></button>`).on("click",(async function(){$(this).text("生成中...");const e=_.unescape($(this).attr("data")),t=await triggerSlash(`/sd quiet=true ${e}`);t?($(this).text("重新生成"),$(this).next("span").empty().append(`<img src="${t}" />`)):$(this).text("重新生成")})).text("生成图片")),t.append('<span class="text_to_image_result"></span>'),t}(e[1])));retrieveDisplayedMessage(n).find(`pre:contains("${e}")`).each((function(e){$(this).replaceWith(a[e])}))}async function a(){$("#chat").children(".mes[is_user='false'][is_system='false']").each(((e,t)=>{n(Number(t.getAttribute("mesid")))}))}$((async()=>{await errorCatched(a)(),eventOn(tavern_events.CHAT_CHANGED,errorCatched(a)),eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED,errorCatched(n)),eventOn(tavern_events.MESSAGE_UPDATED,errorCatched(n)),eventOn(tavern_events.MESSAGE_SWIPED,errorCatched(n)),eventOn(tavern_events.MESSAGE_DELETED,(()=>setTimeout(errorCatched(a),1e3)))}));