const image_tag_regex=new RegExp("<image_tag>(.+?)</image_tag>","gs");async function renderOneMessage(message_id){const $elements=[...getChatMessages(message_id)[0].message.matchAll(image_tag_regex)].map((match=>function extract_element(prompt){const $div=$(`<div class="text_to_image_container" id="text_to_image-${Math.random().toString(36).slice(2,9)}">`);return $div.append("<style>.text_to_image_button{align-items:center;background:linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);border-radius:2px;border:none;box-shadow:0 4px 6px rgba(99,102,241,.2);color:#fff;cursor:pointer;display:inline-flex;font-size:13px;font-weight:600;gap:8px;outline:none;padding:3px 4px;transition:all .3s ease;white-space:nowrap}</style>"),$div.append($(`<button class="text_to_image_button" data="${_.escape(prompt.trim())}"></button>`).on("click",(async function(){$(this).text("生成中...");const prompt=_.unescape($(this).attr("data")),result=await triggerSlash(`/sd quiet=true ${prompt}`);result?($(this).text("重新生成"),$(this).next("span").empty().append(`<img src="${result}" />`)):$(this).text("重新生成")})).text("生成图片")),$div.append('<span class="text_to_image_result"></span>'),$div}(match[1])));retrieveDisplayedMessage(message_id).find('pre:contains("image_tag")').each((function(index){$(this).replaceWith($elements[index])}))}async function renderAllMessage(){$("#chat").children(".mes[is_user='false'][is_system='false']").each(((_index,node)=>{renderOneMessage(Number(node.getAttribute("mesid")))}))}$((async()=>{await errorCatched(renderAllMessage)(),eventOn(tavern_events.CHAT_CHANGED,errorCatched(renderAllMessage)),eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED,errorCatched(renderOneMessage)),eventOn(tavern_events.MESSAGE_UPDATED,errorCatched(renderOneMessage)),eventOn(tavern_events.MESSAGE_SWIPED,errorCatched(renderOneMessage)),eventOn(tavern_events.MESSAGE_DELETED,(()=>setTimeout(errorCatched(renderAllMessage),1e3)))}));