let srcdoc="";async function renderOn(message_element,message){const jquery_message_element=$(message_element),message_id=parseInt(jquery_message_element.attr("mesid"));message=message??await triggerSlash(`/messages names=off ${message_id}`)??"";const mes_text=jquery_message_element.find(".mes_text");mes_text.prop("hidden",!0);const app=jquery_message_element.find(".frontend-app");if(app.length>0)return app.prop("hidden",!1),void eventEmit(`app-${message_id}`,message);const message_script=`<script>window.message = ${JSON.stringify(message)};<\/script>`,message_id_script=`<script>window.message_id = ${message_id};<\/script>`,srcdocWithMessage=srcdoc.replace("</head>",`${message_script}${message_id_script}</head>`),iframe=$("<iframe>").attr("srcdoc",srcdocWithMessage).addClass("frontend-app").css("border","none").css("margin","5px auto").css("width","100%").insertAfter(jquery_message_element.find(".ch_name"));new MutationObserver((()=>{$("#curEditTextarea").parent().is(mes_text)&&(mes_text.prop("hidden",!1),iframe.prop("hidden",!0))})).observe(mes_text.get(0),{childList:!0,subtree:!0,characterData:!0})}async function renderAll(){const nodes=$("#chat").children(".mes[is_user='false'][is_system='false']");for(const node of nodes)renderOn(node)}!function initApp(){const app=$("#script-iframe-App").attr("srcdoc");if(!app)throw Error("{Render} 未找到要渲染的 html 界面");srcdoc=app}(),renderAll(),eventOn(tavern_events.MESSAGE_DELETED,renderAll),eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED,renderAll),eventOn(tavern_events.USER_MESSAGE_RENDERED,renderAll),eventOn(tavern_events.MESSAGE_UPDATED,renderAll),eventOn(tavern_events.MESSAGE_SWIPED,renderAll),eventOn(tavern_events.STREAM_TOKEN_RECEIVED,(async function renderLast(message){const node=$("#chat").children(".mes.last_mes").get(0);node&&renderOn(node,message)}));