{
  "name": "正则替换变量法辅助",
  "content": "const unlock_token_length_debounced=_.debounce((function unlock_token_length(){const settings=SillyTavern.chatCompletionSettings;!0===settings.max_context_unlocked&&2e6===settings.openai_max_context||($(\"#oai_max_context_unlocked\").prop(\"checked\",!0).trigger(\"input\"),$(\"#openai_max_context_counter\").val(2e6),$(\"#openai_max_context\").val(2e6).trigger(\"input\"))}),1e3);$((()=>{eventOn(tavern_events.SETTINGS_UPDATED,unlock_token_length_debounced)}));const variable_regex=/@(.*?)@?=(?:.*?⇒)?'?(.*?)'?((@$)|(?=@))/gm;function stringifyVariables(data){return`${Object.entries(data).map((([key,value])=>`@${key}=${value}@`)).join(\"\\n\")}`}async function updateLastVariables(data){await async function updateVariablesAt(message_id,data){const messages=await getChatMessages(message_id);if(messages.length<=0)return;const message=messages[0].message;await setChatMessage({message:message+`\\n<UpdateVariable>\\n${stringifyVariables(data)}\\n</UpdateVariable>`},message_id,{refresh:\"none\"})}(SillyTavern.chat.length-1,data)}async function propagateVariables(){const last_chat=SillyTavern.chat.at(-1),data=_.merge({},_.pickBy(SillyTavern.chatMetadata?.variables,((_value,key)=>key.startsWith(\"变量\"))),...SillyTavern.chat.slice(-2).map((chat=>function parseVariables(text){return _.merge({},...[...text.matchAll(variable_regex)].map((match=>({[match[1]]:match[2]}))))}(chat.mes)))),updated_message=last_chat.mes.replace(/(?:\\n<UpdateVariable>\\n<FullUpdateVariable>.*?<\\/FullUpdateVariable>\\n<\\/UpdateVariable>)|$/s,`\\n<UpdateVariable>\\n<FullUpdateVariable>\\n${stringifyVariables(data)}\\n</FullUpdateVariable>\\n</UpdateVariable>`);last_chat.swipes&&(last_chat.swipes[last_chat.swipe_id]=updated_message),last_chat.mes=updated_message,await SillyTavern.saveChat()}$((()=>{eventOn(\"在最新楼层更新变量\",updateLastVariables),eventOn(tavern_events.MESSAGE_SENT,propagateVariables),eventOn(tavern_events.MESSAGE_RECEIVED,propagateVariables)})),$((()=>{!async function sync_lorebook_settings(){const EXPECTED_SETTINGS={scan_depth:2,context_percentage:100,budget_cap:0,min_activations:0,max_depth:0,max_recursion_steps:0,insertion_strategy:\"character_first\",include_names:!1,recursive:!0,case_sensitive:!1,match_whole_words:!1,use_group_scoring:!1,overflow_alert:!1},settings=await getLorebookSettings();_.isEqual(_.merge({},settings,EXPECTED_SETTINGS),settings)||setLorebookSettings(EXPECTED_SETTINGS)}()}));",
  "info": "# 正则替换变量法辅助\n\n**作者:** 青空莉想做舞台少女的狗\n**版本:** 2025/04/20\n**相关帖子:** [点此跳转](https://discord.com/channels/1134557553011998840/1308984948794982421)\n**源文件:** [点此跳转](https://gitgud.io/StageDog/tavern_resource/-/tree/main/酒馆助手/正则替换变量法辅助/源文件?ref_type=heads)\n**说明:** [点此跳转](https://sillytavern-stage-girls-dog.readthedocs.io/tool_and_experience/variable_in_lorebook_without_qr/#id13)\n",
  "buttons": []
}